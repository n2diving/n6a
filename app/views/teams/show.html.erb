<% month = params[:rate_period] || ((Date.today - 1.month).end_of_month) %>
<div class="row">
  <div class="col-xs-12 col-sm-10 col-sm-offset-1">
    <div class="row">
      <div class="col-xs-6">
        <h2 class="margin-bottom-lg"><%= @team.team_name %></h2>
      </div>
      <div class="col-xs-6">
        <% if current_user.is_admin %>
          <%= link_to new_team_rating_path, class: "text-primary pull-right margin-top-md" do %>
            <i class="fa fa-plus"></i> new team review
          <% end %>
          <%#= select_tag :id, options_for_select(@users.collect{ |u| [u.full_name, u.id] }), include_blank: "edit user reviews", onchange: "javascript:location.href = '/edit_employee_rating/' + this.value;", class: "form-control margin-bottom-md"  %>
        <% end %>
        <%# if current_user.teams.first.try(:team_lead) %>
          <%= link_to edit_team_reviews_path, class: "text-primary pull-right margin-top-md" do %>
            <i class="fa fa-edit"></i> team reviews
          <%# end %>
          <%#= select_tag :id, options_for_select(@users.collect{ |u| [u.full_name, u.id] }), include_blank: "edit team rating", onchange: "javascript:location.href = '/edit_team_rating/' + this.value;", class: "form-control margin-bottom-md"  %>
        <% end %>

      </div>
    </div>

    <div class="row margin-bottom-lg">
      <div class="col-xs-6">
        <%#= review_chart_results(@team_reviews) %>
        <!--<hr>-->
        <div class="lead">Team Average Performance</div>
        <%= line_chart review_chart_results(@team_reviews) %>
      </div>
      <div class="col-xs-6">
        <%#= team_review_other_teams_chart_results %>
        <!--<hr>-->
        <div class="lead">Team Competitive Performance</div>
        <%= line_chart team_review_other_teams_chart_results %>
      </div>
    </div>

    <hr class="margin-bottom-lg">

    <div class="row margin-bottom-lg">
      <div class="col-xs-12">
        <%= select_tag :rate_period, options_for_select(options_for_rate_period, month), include_blank: "select rate period", class: "form-control", id: "rate_period" %>
      </div>
    </div>

    <%= render "teams/team_yearly_averages", month: month, teams: @team_list %>

    <hr class="margin-top-lg">

    <div class="lead"><%= @team.team_name %> Performance</div>
    <table class="table table-striped table-hover table-bordered datatable">
      <thead>
      <tr>
        <th>employee</th>
        <th>month</th>
        <!--<th class="text-center">average</th>-->
        <% headers = ReviewItem.order(:name).pluck(:display_name, :id) %>
        <% headers.each do |criteria| %>
          <th class="text-center"><%= criteria[0] %></th>
        <% end %>
      </tr>
      </thead>

      <tbody>
        <% teammates = teammates(@team.id) %>
        <% if teammates.any? %>
          <% teammates.each do |one_teammember| %>
            <% rate_period = month.try(:to_date) || (Date.today - 1.month) %>
            <tr>
              <td><%= link_to one_teammember.full_name, one_teammember %></td>
              <td><%= rate_period.strftime("%B %Y") %></td>
              <!--<td class="text-center"><%#= (average.reduce(:+) / average.size.to_f).round(2) %></td>-->
              <% one_teammember.team_user_review_rows(headers, (rate_period)).each do |one_row| %>
                <td class="text-center"><%= one_row[1].first %></td>
              <% end %>
            </tr>
          <% end%>
        <% else %>
          <tr>
            <td colspan="15"><em>There are no team members to display for this team.</em></td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <hr class="margin-top-lg">

    <div class="lead">Team Averages per Month</div>
    <table class="table table-striped table-hover table-bordered datatable">
      <thead>
      <tr>
        <th>month</th>
        <th class="text-center">average</th>
        <% headers2 = ReviewItem.order(:name).pluck(:display_name, :id) %>
        <% headers2.each do |criteria| %>
          <th class="text-center"><%= criteria[0] %></th>
        <% end %>
      </tr>
      </thead>

      <tbody>
      <%# @team_reviews.each do |team_review| %>
      <%# headers.each do |criteria| %>
      <%# review = @team_reviews.where(review_criteria_id: criteria[1]).first %>
      <% @rate_periods.each do |one_month| %>
        <% reviews =  @team_reviews.where(rate_period: one_month.to_datetime.end_of_month).where.not(rating: nil) %>
        <% average = reviews.pluck(:rating) %>
        <% team_review = reviews.first %>
        <%#= team_review.inspect %>
        <% unless team_review.blank? %>
          <tr>
            <td><%= one_month %></td>
            <td class="text-center"><%= (average.reduce(:+) / average.size.to_f).round(2) %></td>
            <% team_review.team_review_rows(headers2, @team.id, one_month.to_datetime.end_of_month).each do |one_row| %>
              <td class="text-center"><%= one_row[1].first %></td>
            <% end %>
          </tr>
        <% end %>
      <% end%>
      <%# end %>
      </tbody>
    </table>

    <%#= link_to 'Edit', edit_team_path(@team) %>
    <!--|-->
    <%#= link_to 'Back', teams_path %>
  </div>
</div>

<script>
  $(function(){
    $('select#rate_period').on('change', function () {
      var url = $(this).val();
      if (url) {
        window.location = "?rate_period="+url.split('%')[0];
      }
      return false;
    });
  });
</script>